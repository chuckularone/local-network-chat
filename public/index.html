<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Network Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
        }

        #login-container h1 {
            margin-bottom: 20px;
            color: #333;
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #login-container button:hover {
            background: #5568d3;
        }

        #chat-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 800px;
            height: 80vh;
            display: none;
            flex-direction: column;
        }

        #chat-header {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chat-header-left h2 {
            margin-bottom: 5px;
        }

        #user-count {
            font-size: 14px;
            opacity: 0.9;
        }

        #logout-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        #logout-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .username {
            font-weight: bold;
            color: #667eea;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .message-text {
            color: #333;
        }

        .system-message {
            text-align: center;
            color: #999;
            font-size: 14px;
            font-style: italic;
            margin: 10px 0;
        }

        #message-form {
            display: flex;
            padding: 20px;
            background: white;
            border-radius: 0 0 10px 10px;
            border-top: 1px solid #eee;
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        #photo-button {
            padding: 12px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #photo-button:hover {
            background: #e0e0e0;
        }

        #photo-input {
            display: none;
        }

        #emoji-button {
            padding: 12px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #emoji-button:hover {
            background: #e0e0e0;
        }

        #send-button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #send-button:hover {
            background: #5568d3;
        }

        .photo-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .photo-message img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
        }

        .photo-caption {
            color: #333;
            margin-top: 10px;
        }

        #photo-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #photo-preview-modal.show {
            display: flex;
        }

        #photo-preview-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
        }

        #photo-preview-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            font-weight: bold;
        }

        #emoji-picker {
            position: absolute;
            bottom: 90px;
            right: 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }

        #emoji-picker.show {
            display: block;
        }

        .emoji-category {
            margin-bottom: 15px;
        }

        .emoji-category:last-child {
            margin-bottom: 0;
        }

        .emoji-category-title {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            font-weight: bold;
            position: sticky;
            top: 0;
            background: white;
            padding: 5px 0;
            z-index: 1;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-bottom: 5px;
        }

        .emoji {
            font-size: 22px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            transition: background 0.2s;
            user-select: none;
            line-height: 1;
        }

        .emoji:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>Local Network Chat</h1>
        <div id="auth-screen">
            <div id="login-form">
                <h2>Login</h2>
                <input type="text" id="login-username" placeholder="Username" autocomplete="username">
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
                <div style="margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer;">
                        <input type="checkbox" id="remember-me" style="width: auto; margin-right: 8px;">
                        <span>Remain logged in</span>
                    </label>
                </div>
                <button id="login-button">Login</button>
                <div id="login-error" style="color: red; margin-top: 10px; display: none;"></div>
                <p style="margin-top: 15px; font-size: 14px;">
                    Don't have an account? <a href="#" id="show-register">Register here</a>
                </p>
            </div>
            <div id="register-form" style="display: none;">
                <h2>Register</h2>
                <input type="text" id="register-username" placeholder="Username (3+ characters)" autocomplete="username">
                <input type="password" id="register-password" placeholder="Password (6+ characters)" autocomplete="new-password">
                <button id="register-button">Register</button>
                <div id="register-error" style="color: red; margin-top: 10px; display: none;"></div>
                <p style="margin-top: 15px; font-size: 14px;">
                    Already have an account? <a href="#" id="show-login">Login here</a>
                </p>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-header">
            <div id="chat-header-left">
                <h2>Chat Room</h2>
                <div id="user-count">Users online: 0</div>
            </div>
            <button id="logout-button">Logout</button>
        </div>
        <div id="messages"></div>
        <div id="emoji-picker">
            <div class="emoji-category">
                <div class="emoji-category-title">Smileys</div>
                <div class="emoji-grid" id="emoji-smileys"></div>
            </div>
            <div class="emoji-category">
                <div class="emoji-category-title">Gestures</div>
                <div class="emoji-grid" id="emoji-gestures"></div>
            </div>
            <div class="emoji-category">
                <div class="emoji-category-title">Hearts</div>
                <div class="emoji-grid" id="emoji-hearts"></div>
            </div>
            <div class="emoji-category">
                <div class="emoji-category-title">Objects</div>
                <div class="emoji-grid" id="emoji-objects"></div>
            </div>
        </div>
        <form id="message-form">
            <input type="file" id="photo-input" accept="image/*">
            <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
            <button type="button" id="photo-button">ðŸ“·</button>
            <button type="button" id="emoji-button">ðŸ˜Š</button>
            <button type="submit" id="send-button">Send</button>
        </form>
    </div>

    <div id="photo-preview-modal">
        <span id="photo-preview-modal-close">&times;</span>
        <img id="photo-preview-img" src="" alt="Preview">
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let username = '';
        let authenticated = false;

        const loginContainer = document.getElementById('login-container');
        const chatContainer = document.getElementById('chat-container');
        
        // Auth elements
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const loginUsername = document.getElementById('login-username');
        const loginPassword = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const rememberMeCheckbox = document.getElementById('remember-me');
        const registerUsername = document.getElementById('register-username');
        const registerPassword = document.getElementById('register-password');
        const registerButton = document.getElementById('register-button');
        const registerError = document.getElementById('register-error');
        
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const userCount = document.getElementById('user-count');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.getElementById('emoji-picker');
        const photoButton = document.getElementById('photo-button');
        const photoInput = document.getElementById('photo-input');
        const photoPreviewModal = document.getElementById('photo-preview-modal');
        const photoPreviewImg = document.getElementById('photo-preview-img');
        const photoPreviewModalClose = document.getElementById('photo-preview-modal-close');
        const logoutButton = document.getElementById('logout-button');

        // Logout handler
        logoutButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('chatUsername');
                location.reload();
            }
        });

        // Check for saved session on page load
        const savedUsername = localStorage.getItem('chatUsername');
        if (savedUsername) {
            console.log('Found saved session for:', savedUsername);
            username = savedUsername;
            loginContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            messageInput.focus();
            
            // Mark socket as authenticated and join
            socket.emit('auto-login', savedUsername);
        }

        // Emoji collections
        const emojis = {
            smileys: ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ¤£', 'ðŸ˜‚', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ¥°', 'ðŸ˜', 'ðŸ¤©', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜š', 'ðŸ˜™', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ˜', 'ðŸ¤‘', 'ðŸ¤—', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤”', 'ðŸ¤', 'ðŸ¤¨', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜’', 'ðŸ™„', 'ðŸ˜¬', 'ðŸ¤¥', 'ðŸ˜Œ', 'ðŸ˜”', 'ðŸ˜ª', 'ðŸ¤¤', 'ðŸ˜´'],
            gestures: ['ðŸ‘‹', 'ðŸ¤š', 'ðŸ–', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤²', 'ðŸ¤', 'ðŸ™'],
            hearts: ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ¤Ž', 'ðŸ–¤', 'ðŸ¤', 'ðŸ’”', 'â£ï¸', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ'],
            objects: ['â­', 'ðŸŒŸ', 'âœ¨', 'âš¡', 'ðŸ”¥', 'ðŸ’¥', 'ðŸ’«', 'ðŸ’¦', 'ðŸ’¨', 'ðŸŽ‰', 'ðŸŽŠ', 'ðŸŽˆ', 'ðŸŽ', 'ðŸ†', 'ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', 'âš½', 'ðŸ€', 'ðŸŽ®', 'ðŸŽ¯', 'ðŸŽ²', 'ðŸŽ¸', 'ðŸŽµ', 'ðŸŽ¶', 'ðŸ“±', 'ðŸ’»', 'âŒš', 'ðŸ“·', 'ðŸŽ¥', 'â˜•', 'ðŸ•', 'ðŸ”', 'ðŸŸ', 'ðŸŒ®', 'ðŸ¦', 'ðŸ°', 'ðŸŽ‚']
        };

        // Populate emoji picker
        function populateEmojis() {
            Object.keys(emojis).forEach(category => {
                const container = document.getElementById(`emoji-${category}`);
                emojis[category].forEach(emoji => {
                    const span = document.createElement('span');
                    span.className = 'emoji';
                    span.textContent = emoji;
                    span.onclick = () => insertEmoji(emoji);
                    container.appendChild(span);
                });
            });
        }

        // Toggle emoji picker
        emojiButton.addEventListener('click', () => {
            emojiPicker.classList.toggle('show');
        });

        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
                emojiPicker.classList.remove('show');
            }
        });

        // Insert emoji at cursor position
        function insertEmoji(emoji) {
            const start = messageInput.selectionStart;
            const end = messageInput.selectionEnd;
            const text = messageInput.value;
            messageInput.value = text.substring(0, start) + emoji + text.substring(end);
            messageInput.focus();
            messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
            emojiPicker.classList.remove('show');
        }

        // Initialize emojis on page load
        populateEmojis();

        // Photo upload functionality
        photoButton.addEventListener('click', () => {
            photoInput.click();
        });

        photoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            
            console.log('File selected:', file.name, 'Type:', file.type, 'Size:', file.size);
            
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                photoInput.value = '';
                return;
            }
            
            // Check file size (limit to 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image too large! Please choose an image under 5MB.');
                photoInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onerror = (error) => {
                console.error('FileReader error:', error);
                alert('Error reading file. Please try again.');
                photoInput.value = '';
            };
            
            reader.onload = (event) => {
                try {
                    if (!username) {
                        console.error('No username set when uploading photo');
                        alert('Error: Not logged in');
                        photoInput.value = '';
                        return;
                    }
                    
                    const caption = prompt('Add a caption (optional):');
                    
                    // User cancelled the prompt
                    if (caption === null) {
                        photoInput.value = '';
                        return;
                    }
                    
                    console.log('Emitting photo message for user:', username);
                    socket.emit('photo message', {
                        username,
                        photo: event.target.result,
                        caption: caption || ''
                    });
                    photoInput.value = '';
                } catch (error) {
                    console.error('Error processing photo:', error);
                    alert('Error uploading photo. Please try again.');
                    photoInput.value = '';
                }
            };
            reader.readAsDataURL(file);
        });

        // Photo preview modal
        photoPreviewModalClose.addEventListener('click', () => {
            photoPreviewModal.classList.remove('show');
        });

        photoPreviewModal.addEventListener('click', (e) => {
            if (e.target === photoPreviewModal) {
                photoPreviewModal.classList.remove('show');
            }
        });

        function showPhotoPreview(src) {
            photoPreviewImg.src = src;
            photoPreviewModal.classList.add('show');
        }

        // Toggle between login and register forms
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            registerError.style.display = 'none';
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            loginError.style.display = 'none';
        });

        // Handle login
        function loginPasswordHandler(e) {
            if (e.key === 'Enter' && loginContainer.style.display !== 'none') handleLogin();
        }
        
        loginButton.addEventListener('click', handleLogin);
        loginPassword.addEventListener('keypress', loginPasswordHandler);

        function handleLogin() {
            const usernameVal = loginUsername.value.trim();
            const passwordVal = loginPassword.value;
            
            if (!usernameVal || !passwordVal) {
                loginError.textContent = 'Please enter username and password';
                loginError.style.display = 'block';
                return;
            }
            
            socket.emit('login', { username: usernameVal, password: passwordVal });
        }

        // Handle registration
        function registerPasswordHandler(e) {
            if (e.key === 'Enter' && loginContainer.style.display !== 'none') handleRegister();
        }
        
        registerButton.addEventListener('click', handleRegister);
        registerPassword.addEventListener('keypress', registerPasswordHandler);

        function handleRegister() {
            const usernameVal = registerUsername.value.trim();
            const passwordVal = registerPassword.value;
            
            if (!usernameVal || !passwordVal) {
                registerError.textContent = 'Please fill in all fields';
                registerError.style.display = 'block';
                return;
            }
            
            if (usernameVal.length < 3) {
                registerError.textContent = 'Username must be at least 3 characters';
                registerError.style.display = 'block';
                return;
            }
            
            if (passwordVal.length < 6) {
                registerError.textContent = 'Password must be at least 6 characters';
                registerError.style.display = 'block';
                return;
            }
            
            socket.emit('register', { username: usernameVal, password: passwordVal });
        }

        // Login/Register responses
        socket.on('login success', (usernameVal) => {
            console.log('Login successful for:', usernameVal);
            username = usernameVal;
            
            // Save to localStorage if remember me is checked
            if (rememberMeCheckbox.checked) {
                localStorage.setItem('chatUsername', usernameVal);
                console.log('Saved session to localStorage');
            } else {
                localStorage.removeItem('chatUsername');
            }
            
            // Remove login event listeners to prevent interference
            loginPassword.removeEventListener('keypress', loginPasswordHandler);
            
            loginContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            messageInput.focus();
            
            console.log('Emitting join event for:', username);
            socket.emit('join', username);
        });

        socket.on('login failed', (message) => {
            loginError.textContent = message;
            loginError.style.display = 'block';
            loginPassword.value = '';
        });

        socket.on('register success', (usernameVal) => {
            username = usernameVal;
            
            // Auto-save session for new registrations
            localStorage.setItem('chatUsername', usernameVal);
            console.log('Saved new user session to localStorage');
            
            // Remove register event listeners to prevent interference
            registerPassword.removeEventListener('keypress', registerPasswordHandler);
            
            loginContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            messageInput.focus();
            socket.emit('join', username);
        });

        socket.on('register failed', (message) => {
            registerError.textContent = message;
            registerError.style.display = 'block';
        });

        // Handle auth required event
        socket.on('auth required', () => {
            console.error('Authentication required - session may have expired');
            alert('Session expired. Please log in again.');
            localStorage.removeItem('chatUsername');
            location.reload();
        });

        // Handle auto-login failure
        socket.on('auto-login failed', () => {
            console.log('Auto-login failed - clearing saved session');
            localStorage.removeItem('chatUsername');
            loginContainer.style.display = 'block';
            chatContainer.style.display = 'none';
        });

        // Handle auto-login success
        socket.on('auto-login success', (usernameVal) => {
            console.log('Auto-login success, joining chat');
            username = usernameVal;
            socket.emit('join', username);
        });

        // Handle socket errors
        socket.on('error', (error) => {
            console.error('Socket error:', error);
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            if (reason === 'io server disconnect') {
                // Server disconnected us - try to reconnect
                socket.connect();
            }
        });

        // Load chat history
        socket.on('chat history', (history) => {
            // Process each item in chronological order
            history.forEach(item => {
                if (item.type === 'message') {
                    // Display text message
                    const messageEl = document.createElement('div');
                    messageEl.className = 'message';
                    messageEl.innerHTML = `
                        <div class="message-header">
                            <span class="username">${escapeHtml(item.username)}</span>
                            <span class="timestamp">${item.timestamp}</span>
                        </div>
                        <div class="message-text">${escapeHtml(item.message)}</div>
                    `;
                    messagesDiv.appendChild(messageEl);
                } else if (item.type === 'photo') {
                    // Display photo
                    const messageEl = document.createElement('div');
                    messageEl.className = 'photo-message';
                    
                    const header = document.createElement('div');
                    header.className = 'message-header';
                    header.innerHTML = `
                        <span class="username">${escapeHtml(item.username)}</span>
                        <span class="timestamp">${item.timestamp}</span>
                    `;
                    
                    const img = document.createElement('img');
                    img.src = item.photo;
                    img.alt = 'Shared photo';
                    img.onclick = () => showPhotoPreview(item.photo);
                    
                    messageEl.appendChild(header);
                    messageEl.appendChild(img);
                    
                    if (item.caption) {
                        const caption = document.createElement('div');
                        caption.className = 'photo-caption';
                        caption.textContent = item.caption;
                        messageEl.appendChild(caption);
                    }
                    
                    messagesDiv.appendChild(messageEl);
                }
            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // Send message
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Make sure user is logged in
            if (!username) {
                console.error('No username set');
                alert('Error: Not logged in');
                return;
            }
            
            const message = messageInput.value.trim();
            if (message) {
                console.log('Sending message:', message, 'from:', username);
                socket.emit('chat message', { username, message });
                messageInput.value = '';
            }
        });

        // Receive messages
        socket.on('chat message', (data) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = `
                <div class="message-header">
                    <span class="username">${escapeHtml(data.username)}</span>
                    <span class="timestamp">${data.timestamp}</span>
                </div>
                <div class="message-text">${escapeHtml(data.message)}</div>
            `;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // Receive photo messages
        socket.on('photo message', (data) => {
            const messageEl = document.createElement('div');
            messageEl.className = 'photo-message';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.innerHTML = `
                <span class="username">${escapeHtml(data.username)}</span>
                <span class="timestamp">${data.timestamp}</span>
            `;
            
            const img = document.createElement('img');
            img.src = data.photo;
            img.alt = 'Shared photo';
            img.onclick = () => showPhotoPreview(data.photo);
            
            messageEl.appendChild(header);
            messageEl.appendChild(img);
            
            if (data.caption) {
                const caption = document.createElement('div');
                caption.className = 'photo-caption';
                caption.textContent = data.caption;
                messageEl.appendChild(caption);
            }
            
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // User joined
        socket.on('user joined', (data) => {
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.textContent = `${data.username} joined the chat`;
            messagesDiv.appendChild(systemMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            userCount.textContent = `Users online: ${data.userCount}`;
        });

        // User left
        socket.on('user left', (data) => {
            const systemMsg = document.createElement('div');
            systemMsg.className = 'system-message';
            systemMsg.textContent = `${data.username} left the chat`;
            messagesDiv.appendChild(systemMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            userCount.textContent = `Users online: ${data.userCount}`;
        });

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
